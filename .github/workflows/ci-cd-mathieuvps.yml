name: E2E Cypress Symfony | Mathieu edition
on:
    push:
        branches: ["main"]
    workflow_dispatch:
    
jobs:
    e2e:
        runs-on: ubuntu-latest
        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_ROOT_HOST: "%"
                    MYSQL_DATABASE: test
                ports:
                    - "3306:3306"
                options: >-
                  --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -proot"
                  --health-interval=10s
                  --health-timeout=5s
                  --health-retries=5
        steps:
            - name: Checkout
              uses: actions/checkout@v6
            - name: Install PHP 8.5
              uses: shivammathur/setup-php@v2
              with:
                php-version: '8.5'
                extensions: mbstring, intl, pdo_mysql, sodium, zip
                tools: composer
                coverage: none
            - name: fichier .env
              run: |
                cat > .env << 'ENV'
                APP_ENV=test
                APP_SECRET=
                APP_SHARE_DIR=var/share
                DEFAULT_URI=
                DATABASE_URL=
                MESSENGER_TRANSPORT_DSN=doctrine://default?auto_setup=0
                MAILER_DSN=null://null
                CORS_ALLOW_ORIGIN='^https?://(localhost|127\.0\.0\.1)(:[0-9]+)?$'
                JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem
                JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem
                JWT_PASSPHRASE=
                ENV
            - name: fichier .env.test
              run: |
                cat > .env.test << 'ENV.TEST'
                DEFAULT_URI=http://127.0.0.1
                APP_SECRET=d9d075bafae3eebb469a1b8fc9c809d7
                DATABASE_URL="mysql://root:root@127.0.0.1:3306/test?serverVersion=8.0.44&charset=utf8mb4"
                JWT_PASSPHRASE="test"
                ENV.TEST
            - name: Installer dÃ©pendances
              run: composer install --no-progress --prefer-dist --no-interaction
            - name: crÃ©ation private et public key
              run: |
                mkdir -p config/jwt
                openssl genrsa -aes256 -passout pass:"$JWT_PASSPHRASE" -out config/jwt/private.pem 4096
                openssl rsa -pubout -passin pass:"$JWT_PASSPHRASE" -in config/jwt/private.pem -out config/jwt/public.pem
              env:
                JWT_PASSPHRASE: test
            - name: Build Tailwind CSS
              run: php bin/console tailwind:build --minify
            - name: Supprimer migrations existantes
              run: rm -f migrations/Version*.php
            - name: CrÃ©er DB & migrate
              run: |
                php bin/console doctrine:database:create
                php bin/console make:migration
                php bin/console doctrine:migrations:migrate
            - name: Start Symfony
              run: php -d display_errors=1 -d error_reporting=E_ALL -S 127.0.0.1:8000 -t public > /tmp/php-server.log 2>&1 &
              env:
                APP_ENV: test
                APP_DEBUG: 1
            - name: Wait for server
              run: |
                for i in {1..30}; do
                  if curl -fsS http://127.0.0.1:8000/ > /dev/null; then
                    echo "Server is ready"
                    exit 0
                  fi
                  echo "Waiting for server... ($i/30)"
                  sleep 2
                done
                echo "Server did not become ready in time"
                exit 1
            - name: Run Cypress
              uses: cypress-io/github-action@v6
              with:
                record: false
            - name: Show PHP server log on failure
              if: failure()
              run: |
                echo "== PHP built-in server log =="
                tail -n 200 /tmp/php-server.log || true
                echo "== Symfony logs =="
                ls -la var/log || true
                tail -n 200 var/log/test.log || true
    deploy:
      needs: e2e
      runs-on: ubuntu-latest
      steps:
        # Checkout du code(rÃ©cupÃ©ration depuis le repo github)
        - name: Checkout
          uses: actions/checkout@v6
        
        # Setup PHP, Composer, extensions
        - name: Setup PHP CLI (Composer & outils)
          uses: shivammathur/setup-php@v2
          with:
            php-version: '8.5'
            extensions: mbstring, intl, pdo_mysql, sodium, zip
            tools: composer
            coverage: none
        - name: fichier .env
          run: |
            cat > .env << 'ENV'
            APP_ENV=prod
            APP_SECRET=
            APP_SHARE_DIR=var/share
            DEFAULT_URI=
            DATABASE_URL=
            MESSENGER_TRANSPORT_DSN=doctrine://default?auto_setup=0
            MAILER_DSN=null://null
            CORS_ALLOW_ORIGIN='^https?://(localhost|127\.0\.0\.1)(:[0-9]+)?$'
            JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem
            JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem
            JWT_PASSPHRASE=
            ENV
        - name: fichier .env.prod
          run: |
            cat > .env.prod << 'ENV.PROD'
            DEFAULT_URI=http://127.0.0.1
            APP_SECRET=d9d075bafae3eebb469a1b8fc9c809d7
            DATABASE_URL="mysql://${{ secrets.BDD_LOGIN }}:${{ secrets.BDD_PASSWORD }}@${{ secrets.BDD_HOST }}/${{ secrets.BDD_NAME }}"
            JWT_PASSPHRASE="teete0159e6ethe"
            ENV.PROD
        # installation des dÃ©pendances composer prod
        - name: Installer dÃ©pendances Composer
          run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
        - name: crÃ©ation private et public key
          run: |
            mkdir -p config/jwt
            openssl genrsa -aes256 -passout pass:"$JWT_PASSPHRASE" -out config/jwt/private.pem 4096
            openssl rsa -pubout -passin pass:"$JWT_PASSPHRASE" -in config/jwt/private.pem -out config/jwt/public.pem
          env:
            JWT_PASSPHRASE: teete0159e6ethe
        - name: Build Tailwind CSS
          run: php bin/console tailwind:build --minify
        - name: Installer lftp
          run: |
            sudo apt-get update
            sudo apt-get install -y lftp

        - name: PrÃ©parer package FTP Hostinger
          run: |
            set -euo pipefail
            rm -rf .deploy
            mkdir -p .deploy/app .deploy/web

            rsync -a --delete \
              --exclude '.git' \
              --exclude '.github' \
              --exclude 'bruno' \
              --exclude 'cypress' \
              --exclude 'tests' \
              --exclude 'node_modules' \
              --exclude 'var' \
              --exclude 'public' \
              ./ .deploy/app/

            rsync -a --delete public/ .deploy/web/

            cat > .deploy/web/index.php <<'PHP'
            <?php

            use App\Kernel;

            $_SERVER['APP_RUNTIME_OPTIONS']['project_dir'] = __DIR__.'/app';

            require_once __DIR__.'/app/vendor/autoload_runtime.php';

            return function (array $context) {
                return new Kernel($context['APP_ENV'], (bool) $context['APP_DEBUG']);
            };
            PHP

        # Deployment via FTP (robuste: reprise + retries)
        - name: ðŸ“‚ Deployment to FTP (reprise auto)
          env:
            FTP_HOST: ${{ secrets.FTP_MAT_SERVER }}
            FTP_USER: ${{ secrets.FTP_MAT_USERNAME }}
            FTP_PASS: ${{ secrets.FTP_MAT_PASSWORD }}
            FTP_PARALLEL: "2"
          run: |
            lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" <<EOF
            set ftp:passive-mode true
            set ftp:list-empty-ok true
            set ssl:check-hostname no
            set ssl:verify-certificate no
            set net:timeout 30
            set net:max-retries 20
            set net:reconnect-interval-base 5
            set net:reconnect-interval-max 60
            set xfer:clobber true
            set mirror:parallel-transfer-count $FTP_PARALLEL

            mkdir -p "/"
            mkdir -p "/app"

            mirror --reverse --continue --delete --only-newer --verbose \
              ./.deploy/app/ "/app"

            mirror --reverse --continue --delete --only-newer --verbose \
              ./.deploy/web/ "/"
            bye
            EOF